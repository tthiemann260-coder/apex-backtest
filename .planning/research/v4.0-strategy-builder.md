# Research: Strategy Builder — v4.0

## Indicator Block System
- Registry pattern: INDICATOR_REGISTRY dict maps type → IndicatorDef
- Each IndicatorDef: compute(closes, highs, lows, **params) → Series | dict
- Output keys: RSI→[rsi], SMA→[sma], MACD→[macd, macd_signal, macd_hist], BBands→[bb_upper, bb_mid, bb_lower]
- Reference convention: "{REF}.{output_key}" e.g. "SMA_50.sma"
- Uses pandas-ta under the hood

## Condition System
- CompareCondition: left, operator, right (operator: gt/lt/gte/lte/eq/crosses_above/crosses_below)
- LogicCondition: operator (and/or/not), operands (list of conditions)
- crosses_above/below: current[left] > current[right] AND previous[left] <= previous[right]
- Right side: either indicator ref (string) or literal number (float)

## JSON Schema (Pydantic v2)
- StrategyDefinition: version, meta, indicators[], entry_long, entry_short, exit_long, exit_short, warmup_bars, signal_strength
- Recursive ConditionModel = CompareConditionModel | LogicConditionModel
- Templates stored as dicts in TEMPLATES registry

## Runtime Compiler
- type() metaclass construction (no exec/eval)
- Closure captures indicator_defs + condition objects
- calculate_signals: update_buffer → compute indicators → evaluate conditions → emit SignalEvent
- _ncb_position state tracking (long/short/"")
- Decimal compliance: indicators use float, signal strength back to Decimal

## Templates (6 built-in)
1. Golden Cross (SMA 50/200)
2. RSI Mean Reversion (RSI 14, 30/70)
3. MACD Momentum (12/26/9 crossover)
4. BB Squeeze Breakout (BBands 20, close > upper)
5. Stoch + RSI Combo (dual oscillator)
6. ADX Trend Filter (ADX > 25 + EMA crossover)

## Validation
- Pass 1 (structural): all refs exist, operators valid
- Pass 2 (semantic): auto-compute warmup, warn no exit, warn no indicators
- ValidationResult: is_valid, errors[], warnings[], auto_warmup

## Dash UI
- New "Strategy Builder" tab with 4 sections
- Indicator rows: dynamic ADD/REMOVE with pattern-matching callbacks (ALL)
- Condition rows: left dropdown + operator + right (ref or literal)
- Central dcc.Store for all form state
- Template load/save via JSON
- Live validation display

---
*Research completed: 2026-02-23*
