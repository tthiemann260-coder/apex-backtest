# v3.0 Architecture Research

**Date:** 2026-02-22
**Scope:** Integration patterns for ICT, Regime, Risk Management, Multi-Asset

## 1. Multi-Symbol Event Loop

### Recommended: Heap-Based Merge into Single Engine
- One `DataHandler` per symbol, each with its own yield-generator
- `merge_bars()` function using `heapq` to chronologically interleave bars
- Single `BacktestEngine` consumes the merged stream
- `MarketEvent.symbol` already exists for routing to correct strategy

### Alternative Rejected: One Engine Per Symbol
- Would require separate Portfolios — defeats multi-asset risk management
- Correlation analysis impossible without shared state

### Key Integration Points
- `BacktestEngine.run()` needs multi-handler support via `merge_bars()`
- `Portfolio.positions` already keyed by symbol — works for multi-asset
- `ExecutionHandler` is stateless — no changes needed
- Strategies need per-symbol buffers (already have `self._bar_buffer`)

## 2. Regime Detection Integration

### Pattern: RegimeGatedStrategy (Decorator)
- Wraps any `BaseStrategy` with regime filter
- Calls `RegimeClassifier.update()` before `inner.calculate_signals()`
- Suppresses signals in non-approved regimes
- Engine remains unchanged — regime logic is internal to strategy

### No New Event Types Needed
- Regime is not an event — it's a classification of market state
- It's computed per-bar inside the strategy, not by the engine
- Avoids event queue pollution

## 3. Risk Management Layer

### Placement: Between Engine and Portfolio
- `RiskManager` is injected into `BacktestEngine.__init__()`
- Engine calls `risk_manager.can_trade()` before converting signal to order
- Engine calls `risk_manager.compute_quantity()` for position sizing
- Replaces hardcoded 10% fixed-fractional in `_calculate_order_quantity()`

### Components
- `KellyPositionSizer` — adaptive sizing from trade history
- `drawdown_scale_factor()` — reduce size during drawdowns
- `PortfolioHeatMonitor` — total open risk tracking
- `RiskManager` — orchestrator combining all constraints

### Stop Distance Problem
- Current `SignalEvent` has no stop_price field
- v3.0 approach: ATR-based proxy (stop_distance = atr * stop_mult)
- Strategy exposes `current_atr` property (SMC already does this)

## 4. Data Handler Multi-Symbol

### Approach: Multiple DataHandlers + Merge
- Each DataHandler loads one symbol
- `merge_bars()` merges chronologically
- Different trading hours handled naturally — only yield bars that exist
- No artificial gap-filling between markets

### Timezone Strategy
- All timestamps in UTC internally
- Kill Zone detection converts UTC to ET for session classification
- DataHandler stores timezone metadata per symbol

## 5. Dashboard Integration

### New Tabs for v3.0
- **Risk Dashboard** — Portfolio heat gauge, position sizing breakdown, daily risk usage
- **Regime Overlay** — Regime classification on main chart (color-coded background)
- **Multi-Asset View** — Per-symbol equity curves, correlation matrix heatmap

---
*Research completed: 2026-02-22*
