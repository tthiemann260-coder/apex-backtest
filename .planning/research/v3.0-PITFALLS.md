# v3.0 Pitfalls Research

**Date:** 2026-02-22

## 1. Multi-Symbol Data Issues

- **Different trading hours:** NYSE 9:30-16:00 ET, Forex 24/5, Indices vary. merge_bars() handles this naturally — only existing bars are yielded. No need for artificial gap-filling.
- **Missing bars alignment:** When one symbol has a bar but another doesn't at the same timestamp, each strategy only receives bars for its own symbol. Portfolio tracks positions independently.
- **yfinance rate limits:** yfinance throttles at ~2000 requests/hour. For 5+ symbols, add caching to Parquet and stagger downloads. Existing DataHandler Parquet cache helps.
- **Timezone handling:** Store all timestamps as UTC internally. Kill Zone detection (London/NY) converts to ET using `zoneinfo.ZoneInfo("America/New_York")`.
- **Volume differences:** Stock volume is integer shares, Forex volume is tick count (unreliable). Don't use volume for cross-asset comparison.

## 2. Risk Management Pitfalls

- **Kelly Criterion overestimation:** With <30 trades, Kelly estimates are unstable. Use fixed fractional as fallback during warmup. Always apply Half Kelly (0.5x) cap.
- **Kelly with perfect stats:** 100% win rate produces extreme Kelly. Hard cap raw Kelly at 0.5 (50%) before applying kelly_factor.
- **Correlation instability:** Correlations shift during market stress (tend toward 1.0). Use rolling window (60-90 bars) for correlation, not full history.
- **Position sizing rounding:** `Decimal.quantize(Decimal('1'), ROUND_DOWN)` for stocks. Forex lots need `Decimal('0.01')` precision.
- **Portfolio heat with stops:** Requires tracking stop prices per position — not currently stored in Portfolio. RiskManager maintains companion dict.
- **Daily risk reset:** On daily bars each bar IS one day. On intraday, reset when `event.timestamp.date()` changes.

## 3. Regime Detection Pitfalls

- **Classification lag:** ADX crosses 25 roughly 2-5 bars after trend starts. Accept lag — use ADX direction (rising/falling) as supplementary signal.
- **Over-fitting regime params:** Use standard thresholds (ADX 20/25/40) not optimized values. Regime parameters should NOT be part of sensitivity sweeps.
- **Regime whipsaws:** Add hysteresis — require regime to persist for N bars (e.g., 3) before switching. Prevents rapid flipping.
- **Different regimes per timeframe:** 1h may show trending while daily shows ranging. Use regime detection on the SAME timeframe as the strategy.

## 4. ICT-Specific Pitfalls

- **Duplicate sweeps:** Same swing level swept multiple times during consolidation. Mark swing points as "swept" after first sweep, cooldown of 10 bars.
- **Partial sweeps:** Wick barely clears level — filter by minimum sweep depth (>= 0.1 * ATR).
- **Sweep without reversal:** Not all sweeps reverse — require close back inside range for confirmation.
- **Kill Zone timezone bugs:** EST vs EDT (Eastern Standard vs Daylight) shifts boundaries by 1 hour. Use `zoneinfo` which handles DST automatically.
- **Equal highs/lows:** Multiple swings at same price = stronger liquidity pool. Detect "near-equal" within 0.5 ATR.

## 5. Testing Challenges

- **Multi-symbol synchronization:** Create deterministic synthetic data with known timestamps for each symbol. Use `datetime` fixtures, not real market data.
- **Mocking multiple data feeds:** One mock DataHandler per symbol, each with controlled bar sequence.
- **Regime transition testing:** Synthetic data with known ATR/ADX values to force specific regime classifications.
- **Risk limit verification:** Test edge cases: max concurrent positions reached, daily risk exhausted, Kelly warmup period, zero stop distance.
- **Heap merge ordering:** Test that bars from different symbols at same timestamp are handled deterministically (secondary sort by symbol name).

---
*Research completed: 2026-02-22*
