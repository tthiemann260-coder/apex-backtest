---
phase: 02-data-layer
plan: 02
type: tdd
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/data_handler.py
  - tests/test_data_handler.py
autonomous: true

must_haves:
  truths:
    - "DataHandler fetches OHLCV data from yfinance for US stocks"
    - "DataHandler fetches OHLCV data from Alpha Vantage for Forex"
    - "First API fetch writes Parquet cache to data/ directory"
    - "Second run with same symbol/date range reads from Parquet, makes zero network calls"
    - "Multi-symbol support works with date range filtering"
  artifacts:
    - path: "src/data_handler.py"
      provides: "Extended DataHandler with API fetch + Parquet caching"
      contains: "yfinance"
    - path: "tests/test_data_handler.py"
      provides: "Extended tests for API + caching + multi-symbol"
      contains: "test_parquet_cache"
  key_links:
    - from: "src/data_handler.py"
      to: "yfinance"
      via: "pip dependency for US stock data"
    - from: "src/data_handler.py"
      to: "alpha_vantage"
      via: "pip dependency for Forex data"
---

<objective>
Extend DataHandler with yfinance and Alpha Vantage API fetchers, Parquet caching after first fetch, and multi-symbol support with date range filtering.

Purpose: The backtesting engine needs real market data. API fetchers provide the data, Parquet caching ensures zero re-download on subsequent runs, and multi-symbol support enables cross-asset strategies.

Output: Extended src/data_handler.py with fetch methods and caching, extended tests.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@CLAUDE.md
@.planning/phases/02-data-layer/02-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add API fetch + Parquet caching tests (RED)</name>
  <files>tests/test_data_handler.py</files>
  <action>
Append to existing `tests/test_data_handler.py`:

**TestYFinanceFetch** — 4 tests (use unittest.mock to avoid real API calls):
1. `test_fetch_yfinance_returns_dataframe` — mock yfinance.download, verify DataFrame returned
2. `test_fetch_yfinance_decimal_conversion` — verify Decimal conversion on fetched data
3. `test_fetch_yfinance_with_date_range` — verify start/end date filtering
4. `test_fetch_yfinance_symbol_set` — verify correct symbol on emitted events

**TestAlphaVantageFetch** — 3 tests (mocked):
1. `test_fetch_alpha_vantage_returns_dataframe` — mock AV API, verify data
2. `test_fetch_alpha_vantage_decimal_conversion` — verify Decimal on Forex data
3. `test_fetch_alpha_vantage_symbol_set` — verify symbol

**TestParquetCaching** — 5 tests:
1. `test_parquet_cache_created_after_fetch` — file exists in data/ after first run
2. `test_parquet_cache_used_on_second_run` — mock API NOT called on second run
3. `test_cache_path_includes_symbol_and_timeframe` — filename format correct
4. `test_cache_invalidation_with_force_refresh` — force_refresh=True re-fetches
5. `test_parquet_roundtrip_decimal_precision` — Decimal precision preserved through Parquet write/read

**TestMultiSymbol** — 3 tests:
1. `test_multi_symbol_separate_handlers` — two DataHandlers for different symbols
2. `test_date_range_filter` — only bars within specified range emitted
3. `test_multi_symbol_independent_generators` — generators don't interfere
  </action>
  <verify>
Tests fail (RED) — new tests reference methods not yet implemented.
  </verify>
  <done>15 new tests written for API fetch, caching, multi-symbol.</done>
</task>

<task type="auto">
  <name>Task 2: Implement API fetchers + Parquet caching (GREEN)</name>
  <files>src/data_handler.py</files>
  <action>
Extend DataHandler with:

1. **Constructor additions:**
   - `start_date: Optional[str]` — "YYYY-MM-DD" format
   - `end_date: Optional[str]` — "YYYY-MM-DD" format
   - `source: str = "csv"` — "csv", "yfinance", "alpha_vantage"
   - `cache_dir: str | Path = "data"`
   - `force_refresh: bool = False`

2. **`_cache_path` property:**
   Returns `{cache_dir}/{symbol}_{timeframe}_{start}_{end}.parquet`

3. **`_load_from_cache()` method:**
   If Parquet file exists and `force_refresh` is False, read with `pd.read_parquet()`.

4. **`_save_to_cache(df)` method:**
   Write DataFrame to Parquet with `df.to_parquet()`.

5. **`_fetch_yfinance()` method:**
   - `import yfinance as yf`
   - `df = yf.download(symbol, start=start_date, end=end_date, interval=timeframe_map[timeframe])`
   - Rename columns to standard: Date, Open, High, Low, Close, Volume
   - Return DataFrame

6. **`_fetch_alpha_vantage()` method:**
   - Use `alpha_vantage.foreignexchange.ForeignExchange`
   - Free tier: `get_currency_exchange_daily()` for daily, intraday for others
   - API key from environment variable `ALPHA_VANTAGE_API_KEY`
   - Return DataFrame with standard column names

7. **`_load_data()` method** (replaces `_load_csv` as internal dispatcher):
   - Check cache first (`_load_from_cache()`)
   - If cache miss: fetch from source, save to cache, return
   - For "csv": use existing CSV loading logic

8. **Update `stream_bars()`:**
   - Call `_load_data()` instead of `_load_csv()`
   - Rest stays the same (yield-generator, Decimal conversion, null-volume skip)

**Parquet Decimal preservation:**
- Before saving: columns stay as float (Parquet doesn't natively store Decimal)
- On loading: convert back via `Decimal(str(value))` in stream_bars()
- The Decimal boundary is ALWAYS in stream_bars(), not in storage

**RULES:**
- NEVER call API if Parquet cache exists (unless force_refresh=True)
- ALL Decimal conversion happens in stream_bars(), not in fetch methods
- API key for Alpha Vantage from env var, never hardcoded
  </action>
  <verify>
Run: `pytest tests/test_data_handler.py -v --tb=short` — ALL tests pass.
Run: `pytest tests/ -v --tb=short` — ALL project tests pass.
  </verify>
  <done>API fetchers + Parquet caching implemented. All tests pass.</done>
</task>

</tasks>

<verification>
- [ ] All new and existing tests pass
- [ ] Parquet cache file created after mock fetch
- [ ] Second run uses cache (API not called)
- [ ] Decimal precision preserved through cache roundtrip
- [ ] Multi-symbol handlers work independently
</verification>

<success_criteria>
- yfinance fetch works (mocked in tests)
- Alpha Vantage fetch works (mocked in tests)
- Parquet caching: write after first fetch, read on subsequent runs
- Multi-symbol with date range filtering
- 15+ new passing tests
</success_criteria>
