---
phase: 02-data-layer
plan: 03
type: tdd
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/data_handler.py
  - tests/test_data_handler.py
autonomous: true

must_haves:
  truths:
    - "Gap dates (weekends, holidays) are forward-filled — no missing dates in output"
    - "DataHandler distinguishes raw vs adjusted prices (split/dividend correction)"
    - "Multi-timeframe bar alignment produces identical timestamp index across symbols"
    - "Forward-fill does not create bars with invented OHLC data beyond the last known bar"
  artifacts:
    - path: "src/data_handler.py"
      provides: "Complete DataHandler with gap handling, adjusted prices, multi-TF alignment"
      contains: "forward_fill"
    - path: "tests/test_data_handler.py"
      provides: "Complete test suite for all DATA-xx requirements"
      contains: "test_gap"
---

<objective>
Complete the DataHandler with gap handling (forward-fill), raw vs adjusted price support, and multi-timeframe bar alignment.

Purpose: Real market data has gaps (weekends, holidays, missing ticks). Forward-fill ensures consistent bar counts. Adjusted prices account for splits/dividends. Multi-timeframe alignment enables strategies that use multiple timeframes simultaneously.

Output: Complete src/data_handler.py covering all DATA-01 through DATA-09 requirements.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@CLAUDE.md
@.planning/phases/02-data-layer/02-01-PLAN.md
@.planning/phases/02-data-layer/02-02-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write gap handling + adjusted prices + alignment tests (RED)</name>
  <files>tests/test_data_handler.py</files>
  <action>
Append to existing `tests/test_data_handler.py`:

**TestGapHandling** — 5 tests:
1. `test_forward_fill_weekend_gaps` — Friday→Monday gap filled with Friday's close
2. `test_forward_fill_holiday_gaps` — missing dates filled
3. `test_no_forward_fill_beyond_last_bar` — generator stops at last real bar
4. `test_forward_filled_bars_have_zero_volume` — filled bars get volume=0 (but are NOT rejected since they're fill bars, not real zero-volume)
5. `test_gap_fill_preserves_real_data` — real bars unchanged after fill

IMPORTANT: Forward-filled bars MUST be distinguishable from real bars.
Design decision: Forward-filled bars are emitted with volume=0 BUT we need a separate flag or the null-volume rejection must NOT apply to forward-filled bars.

REVISED: Forward-filled bars get volume=-1 as a sentinel value to distinguish from real zero-volume (which are rejected). OR: Add `is_fill: bool` field... NO — MarketEvent is frozen and we cannot change it.

BEST APPROACH: Gap filling creates bars but marks them. DataHandler has a `fill_gaps: bool = False` flag. When True, it fills gaps but emits them with the LAST KNOWN CLOSE as OHLC (all same) and volume=1 (synthetic minimum). The null-volume rejection (volume==0) still works for REAL zero-volume bars from raw data.

**TestAdjustedPrices** — 3 tests:
1. `test_raw_prices_returned_by_default` — use_adjusted=False (default)
2. `test_adjusted_prices_when_requested` — use_adjusted=True returns Adj Close mapped to Close
3. `test_split_adjusted_prices_differ` — for a stock with a known split, raw != adjusted

**TestMultiTimeframeAlignment** — 4 tests:
1. `test_align_two_symbols_daily` — aligned timestamps match
2. `test_align_fills_missing_with_forward_fill` — missing symbol dates filled
3. `test_align_returns_dict_of_generators` — one generator per symbol
4. `test_different_timeframes_same_symbol` — daily and weekly aligned correctly
  </action>
  <verify>
Tests fail (RED phase).
  </verify>
  <done>12 new tests written for gap handling, adjusted prices, multi-TF alignment.</done>
</task>

<task type="auto">
  <name>Task 2: Implement gap handling + adjusted prices + alignment (GREEN)</name>
  <files>src/data_handler.py</files>
  <action>
Extend DataHandler:

1. **Constructor additions:**
   - `fill_gaps: bool = False` — enable forward-fill for gaps
   - `use_adjusted: bool = False` — use adjusted close instead of raw close

2. **`_forward_fill_gaps(df)` method:**
   - Identify date range (min to max Date)
   - Create complete date index (business days for stocks, all days for Forex)
   - Reindex DataFrame with forward-fill
   - Forward-filled rows: OHLC all set to last known Close, Volume set to 1
   - Return filled DataFrame

3. **`_apply_adjusted_prices(df)` method:**
   - If "Adj Close" column exists: replace Close with Adj Close
   - Calculate adjustment ratio: `adj_ratio = Adj Close / Close`
   - Apply ratio to Open, High, Low as well
   - Drop "Adj Close" column
   - Return adjusted DataFrame

4. **`_load_data()` update:**
   - After loading (from cache or API): apply adjusted prices if requested
   - After adjustment: apply gap fill if requested
   - Then return DataFrame

5. **`align_multi_symbol(handlers)` class method:**
   ```python
   @staticmethod
   def align_multi_symbol(
       handlers: list[DataHandler],
   ) -> dict[str, Generator[MarketEvent, None, None]]:
   ```
   - Load all DataFrames
   - Find intersection of date ranges
   - Forward-fill missing dates per symbol within intersection
   - Return dict mapping symbol -> generator

**RULES:**
- Forward-fill uses LAST KNOWN values only — never extrapolates beyond data
- Adjusted prices ratio applied to all OHLC, not just Close
- Multi-timeframe alignment: each symbol's generator is independent
- Business day calendar for stocks, full calendar for Forex (no weekend gaps in FX)
  </action>
  <verify>
Run: `pytest tests/test_data_handler.py -v --tb=short` — ALL tests pass.
Run: `pytest tests/ -v --tb=short` — ALL project tests pass.
  </verify>
  <done>Gap handling, adjusted prices, and multi-TF alignment implemented. All tests pass.</done>
</task>

</tasks>

<verification>
- [ ] All tests pass including new gap/adjustment/alignment tests
- [ ] Forward-filled bars use synthetic volume (not rejected by null-volume filter)
- [ ] Adjusted prices correctly scale OHLC
- [ ] Multi-symbol alignment produces matching timestamp indices
- [ ] All DATA-01 through DATA-09 requirements satisfied
</verification>

<success_criteria>
- Gap handling: forward-fill with synthetic bars
- Raw vs adjusted prices: configurable
- Multi-timeframe alignment: static method
- All 46+ tests pass across the full project
- Complete DATA layer ready for Phase 3 (Strategy)
</success_criteria>
